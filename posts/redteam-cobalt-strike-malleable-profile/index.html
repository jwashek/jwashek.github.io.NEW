<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Cobalt Strike 4.0+ Malleable C2 Profile Guideline | bigb0ss</title><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Cobalt Strike 4.0+ Malleable C2 Profile Guideline" /><meta name="author" content="bigb0ss" /><meta property="og:locale" content="en_US" /><meta name="description" content="Intro" /><meta property="og:description" content="Intro" /><link rel="canonical" href="https://bigb0sss.github.io/posts/redteam-cobalt-strike-malleable-profile/" /><meta property="og:url" content="https://bigb0sss.github.io/posts/redteam-cobalt-strike-malleable-profile/" /><meta property="og:site_name" content="bigb0ss" /><meta property="og:image" content="https://bigb0sss.github.io/assets/img/post/redteam-cobalt-strike/cs2.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-10-23T11:25:00-04:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://bigb0sss.github.io/assets/img/post/redteam-cobalt-strike/cs2.png" /><meta property="twitter:title" content="Cobalt Strike 4.0+ Malleable C2 Profile Guideline" /><meta name="twitter:site" content="@bigb0ss___" /><meta name="twitter:creator" content="@bigb0ss" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"bigb0ss"},"description":"Intro","@type":"BlogPosting","headline":"Cobalt Strike 4.0+ Malleable C2 Profile Guideline","dateModified":"2020-10-23T11:25:00-04:00","datePublished":"2020-10-23T11:25:00-04:00","url":"https://bigb0sss.github.io/posts/redteam-cobalt-strike-malleable-profile/","image":"https://bigb0sss.github.io/assets/img/post/redteam-cobalt-strike/cs2.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://bigb0sss.github.io/posts/redteam-cobalt-strike-malleable-profile/"},"@context":"https://schema.org"}</script><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" async></script> <script src="/assets/js/post.min.js" async></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-QE26N8SZTJ"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-QE26N8SZTJ'); </script> <script src="/app.js" defer></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/bigb0ss/bigb0ss.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">bigb0ss</a></div><div class="site-subtitle font-italic">OSCE | OSCP | Security Blog</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>BLOGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <a href="https://www.linkedin.com/in/danielsmin" target="_blank"> <i class="fab fa-linkedin"></i> </a> <a href="https://github.com/bigb0sss" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/bigb0ss___" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Cobalt Strike 4.0+ Malleable C2 Profile Guideline</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Cobalt Strike 4.0+ Malleable C2 Profile Guideline</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Oct 23, 2020" > Oct 23 <i class="unloaded">2020-10-23T11:25:00-04:00</i> </span> by <span class="author"> bigb0ss </span></div><div> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Nov 19, 2020" > Nov 19 <i class="unloaded">2020-11-19T18:45:01-05:00</i> </span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/post/redteam-cobalt-strike/cs2.png" class="post-preview-img"><h2 id="intro">Intro</h2><p>We are now in the Cobalt Strike 4.0+ era. As Cobalt Strike is getting more popular choice for the Command and Control (“C2”) server nowadays, customizing your malleable C2 profile is imperative to disguise your beacon traffics as well as communication indicators. Additionally, it can also help dictate in-memory characteristics and beacon process injection behaviors.</p><p>The full profile creation guide can be found here <a href="https://github.com/bigb0sss/RedTeam/blob/master/CobaltStrike/malleable_C2_profile/CS4.0_guideline.profile">CS4.0_guideline.profile</a>. It contains more details/instructions to craft the Malleable C2 profiles.</p><h2 id="global-option-block">Global Option Block</h2><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="s">set sample_name "bigb0ss.profile";</span> <span class="c1"># Profile name (used in the Indicators of Compromise report)</span>

<span class="s">set sleeptime "30000";</span> <span class="c1"># Sleep time for the beacon callback (in milliseconds)</span>
  
<span class="s">set jitter "50";</span> <span class="c1"># Jitter to set %. In this example, the beacon will callback between 15 and 30 sec jitter</span>
  
<span class="s">set host_stage "[true|false]";</span> <span class="c1"># Staged payload allow or disallow (Note: Stager payloads are generally easier to get caught, but it's necessary for the space-restricted situations)</span>
  
<span class="s">set useragent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.140 Safari/537.36 Edge/18.177";</span> <span class="c1"># User-Agent Setup</span>
</pre></table></code></div></div><h2 id="dns-beacon-block">DNS Beacon Block</h2><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="s">set dns_idel "8.8.8.8";</span> <span class="c1"># IP to indicate no tasks available. Avoid using bogon address "0.0.0.0" (This can be picked up as IOC)</span>
  
<span class="s">set maxdns "[0-255]";</span> <span class="c1"># Maximum length of hostname when uploading data over DNS (0-255)</span>
  
<span class="s">set dns_sleep "1000";</span> <span class="c1"># Force a sleep prior to each individual DNS request. (in milliseconds)</span>
  
<span class="s">set dns_stager_prepend "";</span> <span class="c1"># Prepend text to payload stage delivered to DNS TXT record stager</span>
  
<span class="s">set dns_stager_subhost ".stage.8546.";</span> <span class="c1"># Subdomain used by DNS TXT record stager</span>
  
<span class="s">set dns_max_txt "[0-255]";</span> <span class="c1"># Maximum length of DNS TXT responses for tasks</span>
  
<span class="s">set dns_ttl "1";</span> <span class="c1"># TTL for DNS replies</span>
</pre></table></code></div></div><h2 id="smb-beacon-block">SMB Beacon Block</h2><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="s">set pipename "win_svc+8546";</span> <span class="c1"># Name of pipe to use for SMB beacon's peer-to-peer communication</span>
  
<span class="s">set pipename_stager "win_svc+8546";</span> <span class="c1"># Name of pipe to use for SMB beacon's named pipe stager</span>
</pre></table></code></div></div><h2 id="tcp-beacon-block">TCP Beacon Block</h2><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="s">set tcp_port "1337";</span> <span class="c1"># TCP beacon listen port</span>
</pre></table></code></div></div><h2 id="sslcode-certificate-block">SSL/Code Certificate Block</h2><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c1">### Self-Signed Certificate HTTPS Beacon Block </span>
<span class="s">https-certificate {</span>
    <span class="s">set C "US";</span>                         <span class="c1"># Country</span>
    <span class="s">set CN "google.com";</span>                <span class="c1"># Common Name</span>
    <span class="s">set L "Mountain View";</span>              <span class="c1"># Locality</span>
    <span class="s">set O "Alphabet Inc.";</span>              <span class="c1"># Organization Name</span>
    <span class="s">set OU "Google Certificate";</span>        <span class="c1"># Organizational Unit Name</span>
    <span class="s">set ST "CA";</span>                        <span class="c1"># State</span>
    <span class="s">set validity "365"; }</span>
 
<span class="c1">### Valid SSL Certificate HTTPS Beacon Block </span>
<span class="s">https-certificate {</span>
    <span class="s">set keystore "domain.store";</span>        
      <span class="s"># Private key, root cert, intermediate cert and domain cert -</span> 
      <span class="s"># Java Keystore file should be in the same folder with Malleable C2 profile</span>    
    <span class="s">set password "&lt;mypassword&gt;"; }</span>         
      <span class="s"># The password to your Java Keystore</span>

<span class="c1">### Code Signing Certificate Block</span>
<span class="s">code-signer {</span>
    <span class="s">set keystore "keystore.jks";</span>
    <span class="s">set password "&lt;mypassword&gt;";</span>
    <span class="s">set alias "server"; }</span>
</pre></table></code></div></div><h2 id="https-block">HTTP/S Block</h2><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
</pre><td class="rouge-code"><pre><span class="c1">### HTTP/S Global Response Header Block</span>
<span class="s">http-config {</span>
    <span class="s">set headers "Server, Content-Type, Cache-Control, Connection, X-Powered-By";</span>        
    <span class="s">header "Server" "Microsoft-IIS/8.5";</span>
    <span class="s">header "Content-Type" "text/html;charset=UTF-8";</span>
    <span class="s">header "Cache-Control" "max-age=1";</span>
    <span class="s">header "Connection" "keep-alive";</span>
    <span class="s">header "X-Powered-By" "ASP.NET";</span>
    <span class="s">set trust_x_forwarded_for "[true|false]"; }</span> <span class="c1"># "true" if the team server is behind an HTTP redirector</span>

<span class="c1">### HTTP-GET Block</span>
<span class="s">http-get {</span>
    <span class="s">set uri "/image/xxxxxx";</span> <span class="c1"># For multiple URIs = "/image /index /sexy"</span>
    
    <span class="s">set verb "[GET|POST]"</span> <span class="c1"># Not really need to config this for http-get, but you can change it to POST if you want</span>

    <span class="s">client {</span>
        <span class="s">header "Host" "domain.com";</span>
        <span class="s">header "Accept" "*/*";</span>
        <span class="s">header "Accept-Language" "en-US";</span>
        <span class="s">header "Connection" "close"; }</span>
    
<span class="c1">### Data Transform Language</span>
    <span class="s">metadata {</span>
        <span class="s">base64;</span>                     <span class="c1"># Base64 Encode</span>
        <span class="s">base64url;</span>                  <span class="c1"># URL-safe Base64 Encode</span>
        <span class="s">mask;</span>                       <span class="c1"># XOR mask w/ random key</span>
        <span class="s">netbios;</span>                    <span class="c1"># NetBIOS Encode 'a'</span>
        <span class="s">netbiosu;</span>                   <span class="c1"># NetBIOS Encode 'A'</span>
        <span class="s">prepend "user=";</span>            <span class="c1"># Prepend "string"</span>
        <span class="s">append ".asp";</span>              <span class="c1"># Append "string"</span>

<span class="c1">### Termination Statements</span>
        <span class="s">parameter "key";</span>            <span class="c1"># Store data in a URI parameter</span>
        <span class="s">header "Cookie";</span>            <span class="c1"># Store data in an HTTP header</span>
        <span class="s">uri-append;</span>                 <span class="c1"># Append to URI</span>
        <span class="s">print; }</span> <span class="c1"># Send data as transaction body (set "verb" to POST to use "print")</span>

    <span class="s">server {</span>
        <span class="s">header "Server" "Apache";</span> <span class="c1"># headers will be pulled from the http-config block, or manually add your preferences below:</span>

        <span class="s">output {</span>
            <span class="s">base64;</span>                         <span class="c1"># Base64 Encode</span>
            <span class="s">base64url;</span>                      <span class="c1"># URL-safe Base64 Encode</span>
            <span class="s">mask;</span>                           <span class="c1"># XOR mask w/ random key</span>
            <span class="s">netbios;</span>                        <span class="c1"># NetBIOS Encode 'a'</span>
            <span class="s">netbiosu;</span>                       <span class="c1"># NetBIOS Encode 'A'</span>
            <span class="s">prepend "user=";</span>                <span class="c1"># Prepend "string"</span>
            <span class="s">append ".asp";</span>                  <span class="c1"># Append "string"</span>
            <span class="s">print; } } }</span> <span class="c1"># Server block MUST be terminated with "print"</span>

<span class="c1">### HTTP-POST Block</span>
<span class="s">http-post {</span>
    <span class="s">set uri "/image/xxxxxx";</span> <span class="c1"># For multiple URIs = "/image /index /sexy"    </span>
      
    <span class="s">set verb "[GET|POST]";</span> <span class="c1"># Use "GET" for GET Only C2</span>

    <span class="s">client {</span>
        <span class="s">header "Host" "domain.com";</span>
        <span class="s">header "Accept" "*/*";</span>
        <span class="s">header "Accept-Language" "en-US";</span>
        <span class="s">header "Connection" "close";</span>

        <span class="s">id {</span>                                    
            <span class="s">base64;</span>                    <span class="c1"># Base64 Encode</span>
            <span class="s">base64url;</span>                 <span class="c1"># URL-safe Base64 Encode</span>
            <span class="s">mask;</span>                      <span class="c1"># XOR mask w/ random key</span>
            <span class="s">netbios;</span>                   <span class="c1"># NetBIOS Encode 'a'</span>
            <span class="s">netbiosu;</span>                  <span class="c1"># NetBIOS Encode 'A'</span>
            <span class="s">prepend "user=";</span>           <span class="c1"># Prepend "string"</span>
            <span class="s">append ".asp";</span>             <span class="c1"># Append "string"</span>
            <span class="s">parameter "id";</span>            <span class="c1"># Add Beacon ID in parameter</span>
            <span class="s">header "ID-Header"; }</span>      <span class="c1"># Add Beacon ID in header</span>
        

        <span class="s">output {</span>
            <span class="s">base64;</span>                  <span class="c1"># Base64 Encode</span>
            <span class="s">base64url;</span>               <span class="c1"># URL-safe Base64 Encode</span>
            <span class="s">mask;</span>                    <span class="c1"># XOR mask w/ random key</span>
            <span class="s">netbios;</span>                 <span class="c1"># NetBIOS Encode 'a'</span>
            <span class="s">netbiosu;</span>                <span class="c1"># NetBIOS Encode 'A'</span>
            <span class="s">prepend "user=";</span>         <span class="c1"># Prepend "string"</span>
            <span class="s">append "asp";</span>            <span class="c1"># Append "string"</span>
            <span class="s">parameter "key";</span>         <span class="c1"># Store data in a URI parameter</span>
            <span class="s">header "Cookie";</span>         <span class="c1"># Store data in an HTTP header</span>
            <span class="s">uri-append; } }</span>          <span class="c1"># Append to URI</span>

    <span class="s">server {</span>
        <span class="s">header "Server" "Apache";</span> <span class="c1"># headers will be pulled from the http-config block, or manually add your preferences below:</span>

        <span class="s">output {</span>
            <span class="s">base64;</span>                         <span class="c1"># Base64 Encode</span>
            <span class="s">base64url;</span>                      <span class="c1"># URL-safe Base64 Encode</span>
            <span class="s">mask;</span>                           <span class="c1"># XOR mask w/ random key</span>
            <span class="s">netbios;</span>                        <span class="c1"># NetBIOS Encode 'a'</span>
            <span class="s">netbiosu;</span>                       <span class="c1"># NetBIOS Encode 'A'</span>
            <span class="s">prepend "user=";</span>                <span class="c1"># Prepend "string"</span>
            <span class="s">append ".asp";</span>                  <span class="c1"># Append "string"</span>
            <span class="s">print; } } }</span> <span class="c1"># Server block MUST be terminated with "print"</span>

<span class="c1">### HTTP-Stager Block </span>
<span class="s">http-stager {</span>
    <span class="s">set uri_x86 "/get32.gif";</span> <span class="c1"># Set to download 32-bit payload stage    </span>
      
    <span class="s">set uri_x64 "/get64.gif";</span> <span class="c1"># Set to download 64-bit payload stage</span>

    <span class="s">client {</span>  <span class="c1"># Clinet = Defining the client side of the HTTP transaction.</span>
        <span class="s">header "Host" "domain.com";</span>
        <span class="s">header "Accept" "*/*";</span>
        <span class="s">header "Accept-Language" "en-US";</span>
        <span class="s">header "Connection" "close";</span>
        <span class="s">header "Cookie" "XXXXXX"</span>
        <span class="s">parameter "id" "8645"; }</span>

    <span class="s">server {</span> <span class="c1"># headers will be pulled from the http-config block, or manually add your preferences below:</span>
        <span class="s">header "Server" "Apache";</span>

        <span class="s">output {</span>
            <span class="s">base64;</span>                         <span class="c1"># Base64 Encode</span>
            <span class="s">base64url;</span>                      <span class="c1"># URL-safe Base64 Encode</span>
            <span class="s">mask;</span>                           <span class="c1"># XOR mask w/ random key</span>
            <span class="s">netbios;</span>                        <span class="c1"># NetBIOS Encode 'a'</span>
            <span class="s">netbiosu;</span>                       <span class="c1"># NetBIOS Encode 'A'</span>
            <span class="s">prepend "user=";</span>                <span class="c1"># Prepend "string"</span>
            <span class="s">append ".asp";</span>                  <span class="c1"># Append "string"</span>
            <span class="s">print; } } }</span> <span class="c1"># Server block MUST be terminated with "print"</span>
</pre></table></code></div></div><h2 id="malleable-pe--in-memory-evasion-and-obfuscation-block">Malleable PE &amp; In-Memory Evasion and Obfuscation Block</h2><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="s">stage {</span>
    <span class="s">set checksum "0";</span> <span class="c1"># The CheckSum value in Beacon's PE header    </span>
    
    <span class="s">set cleanup "[true|false]";</span> <span class="c1"># If "true," free memory associated with the Reflective DLL package when it's no longer needed    </span>
      
    <span class="s">set compile_time "02 April 2020 02:35:00";</span> <span class="c1"># The build time in Beacon's PE header    </span>
      
    <span class="s">set entry_point "92145";</span> <span class="c1"># The EntryPoint value in Beacon's PE header    </span>
      
    <span class="s">set image_size_x86 "512000";</span> <span class="c1"># SizeOfImage value in x86 Beacon's PE header ([!] Avoid using image_size_x86 if module_x86 in use)    </span>
      
    <span class="s">set image_size_x64 "512000";</span> <span class="c1"># SizeOfImage value in x64 Beacon's PE header ([!] Avoid using image_size_x64 if module_x64 in use)    </span>
      
    <span class="s">set module_x86 "legit.dll";</span> <span class="c1"># Ask the x86 ReflectiveLoader to load the specified library and overwrite its space instead of allocating memory with VirtualAlloc    </span>
      
    <span class="s">set module_x64 "legit.dll";</span> <span class="c1"># Ask the x64 ReflectiveLoader to load the specified library and overwrite its space instead of allocating memory with VirtualAlloc    </span>
      
    <span class="s">set name "legit.dll";</span> <span class="c1"># The Exported name of the Beacon DLL    </span>
      
    <span class="s">set rich_header "\x00\x00\x00\x00";</span> <span class="c1"># Meta-information inserted by the compiler. The Rich header is a PE section that serves as a fingerprint of a Windows’ executable build environment</span>

    <span class="s">set sleep_mask "[true|false]";</span> <span class="c1"># Obfuscate Beacon, in-memory, prior to sleeping    </span>
      
    <span class="s">set stomppe "[true|false]";</span> <span class="c1"># Ask ReflectiveLoader to stomp MZ, PE, and e_lfanew values after it loads Beacon payload</span>
                                                        
    <span class="s">set obfuscate "[true|false]";</span> <span class="c1"># Obfuscate the Reflective DLL's import table (can be IOC), overwrite unused header content, and ask ReflectiveLoader to copy Beacon to new memory without its DLL headers</span>
                                                     
    <span class="s">set userwx "[true|false]";</span> <span class="c1"># Ask ReflectiveLoader to use or avoid RWX permissions for Beacon DLL in memory (can be IOC)</span>
                                               
    <span class="s">transform-x86 {</span>
        <span class="s">prepend "\x90\x90\x90";</span> <span class="c1"># Inserts a string before Beacon's Reflective DLL --&gt; Defeat analysis on the first few bytes of a memory segment of an injected DLL        </span>
        
        <span class="s">append "\x90\x90\x90";</span> <span class="c1"># Adds a string after the Beacon Reflective DLL        </span>
          
        <span class="s">strrep "ReflectiveLoader" ""; }</span> <span class="c1"># Replaces a string within Beacon's Reflective DLL --&gt; Defeat analysis on tool-specific strings</span>

    <span class="s">transform-x64 {</span>
        <span class="s">prepend "\x90\x90\x90";</span>                     
        <span class="s">append "\x90\x90\x90";</span>                      
        <span class="s">strrep "ReflectiveLoader" ""; }</span>

    <span class="s">data "&lt;whatever string&gt;";</span> <span class="c1"># Adds a string as-is (ex) "bigb0ss")    </span>
      
    <span class="s">string "&lt;whatever string&gt;";</span> <span class="c1"># Adds a null-terminated string (ex) {'b','i','g','b','0','s','s','\0'})    </span>
      
    <span class="s">stringw "&lt;whatever string&gt;"; }</span> <span class="c1"># Adds a wide (UTF-16LE encoded) string (ex) 0062 0069 0067 0062 0030 0073 0073)</span>
</pre></table></code></div></div><h2 id="process-injection-block">Process Injection Block</h2><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="s">process-inject {</span>
    <span class="s">set allocator "[VirtualAllocEx|NtMapViewOfSection]";</span> <span class="c1"># The preferred method to allocate memory in the remote process. </span>
                                                              
    <span class="s">set min_alloc "4096";</span> <span class="c1"># Minimum amount of memory to request for injected content    </span>
      
    <span class="s">set startrwx "[true|false]";</span> <span class="c1"># Use RWX as initial permissions for injected content. Alternative is RW.    </span>
      
    <span class="s">set userwx "[true|false]";</span> <span class="c1"># Use RWX as final permissions for injected content. Alternative is RX.</span>

    <span class="s">transform-x86 {</span>
        <span class="s">prepend "\x90\x90\x90";</span>                     
        <span class="s">append "\x90\x90\x90"; }</span>

    <span class="s">transform-x64 {</span>
        <span class="s">prepend "\x90\x90\x90";</span>                     
        <span class="s">append "\x90\x90\x90"; }</span>

    <span class="s">execute {</span>
        <span class="s">CreateThread "ntdll.dll!RtlUserThreadStart+0x1000";</span> <span class="c1"># Current process only ([!] Sysmon EventID 8 - a process creates a thread in another process)        </span>
          
        <span class="s">CreateRemoteThread "kernel32.dll!LoadLibraryA+0x1000";</span> <span class="c1"># No cross-session ([!] Sysmon EventID 8 - a process creates a thread in another process)        </span>
          
        <span class="s">NtQueueApcThread;</span> <span class="c1"># Uses RWX shellcode and "CreateThread" start address. Same-arch injection only        </span>
          
        <span class="s">NtQueueApcThread-s;</span> <span class="c1"># "Early Bird" injection technique. Suspended process only</span>
          
        <span class="s">RtlCreateUserThread;</span> <span class="c1"># Risky on XP-era targets. Uses RWX shellcode for x86 -&gt; x64 injection. ([!] Sysmon EventID 8 - a process creates a thread in another process)        </span>
          
        <span class="s">SetThreadContext; } }</span> <span class="c1"># Suspended process only</span>
</pre></table></code></div></div><h2 id="post-exploitation-block">Post-Exploitation Block</h2><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="s">post-ex {</span>
        <span class="s">set spawnto_x86 "%windir%\\syswow64\\&lt;mfpmp&gt;.exe";</span>              
        <span class="s">set spawnto_x64 "%windir%\\sysnative\\&lt;mfpmp&gt;.exe";</span>             
        <span class="s">set obfuscate "[true|false]";</span> <span class="c1"># Obfuscate the permissions and content of our post-ex DLLs</span>
          
        <span class="s">set smartinject "[true|false]";</span> <span class="c1"># Directs Beacon to embed key function pointers (ex) GetProcAddress, LoadLibrary) into its same-arch post-ex DLLs </span>
                                                                    
        <span class="s">set amsi_disable "[true|false]"; }</span> <span class="c1"># Disable AMSI (Antimalware Scan Interface) in powerpick, execute-assembly and psinject before loading .NET or PS code</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/redteam/'>RedTeam</a>, <a href='/categories/cobalt-strike/'>Cobalt Strike</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/cobalt-strike/" class="post-tag no-text-decoration" >cobalt strike</a> <a href="/tags/malleable-c2/" class="post-tag no-text-decoration" >malleable c2</a> <a href="/tags/redteam/" class="post-tag no-text-decoration" >redteam</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://bigb0sss.github.io/posts/redteam-cobalt-strike-malleable-profile/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="https://twitter.com/intent/tweet?text=Cobalt Strike 4.0+ Malleable C2 Profile Guideline - bigb0ss&url=https://bigb0sss.github.io/posts/redteam-cobalt-strike-malleable-profile/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Cobalt Strike 4.0+ Malleable C2 Profile Guideline - bigb0ss&u=https://bigb0sss.github.io/posts/redteam-cobalt-strike-malleable-profile/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Cobalt Strike 4.0+ Malleable C2 Profile Guideline - bigb0ss&url=https://bigb0sss.github.io/posts/redteam-cobalt-strike-malleable-profile/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/redteam-rotate-ip-aws-gateway/">Rotating Source IPs (Part 1) - AWS API Gateway</a><li><a href="/posts/htb-servmon-writeup/">HTB - ServMon Write-up</a></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/x86/">x86</a> <a class="post-tag" href="/tags/slae32/">slae32</a> <a class="post-tag" href="/tags/assembly/">assembly</a> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/cloud/">cloud</a> <a class="post-tag" href="/tags/zip2john/">zip2john</a> <a class="post-tag" href="/tags/web.config-rce/">web.config rce</a> <a class="post-tag" href="/tags/vhost/">vhost</a> <a class="post-tag" href="/tags/valentine/">valentine</a> <a class="post-tag" href="/tags/tomcat/">tomcat</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-2">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/redteam-rotate-ip-aws-gateway/"><div class="card-body"> <span class="timeago small" > Nov 19 <i class="unloaded">2020-11-19T10:36:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Rotating Source IPs (Part 1) - AWS API Gateway</h3><div class="text-muted small"><p> Intro During a security engagement, especially for an evasive/covert type of assessment, you might need to hide your traffic as much as possible. Or if the client has implemented some type of IP b...</p></div></div></a></div><div class="card"> <a href="/posts/slae32-assignment-3/"><div class="card-body"> <span class="timeago small" > Dec 26 <i class="unloaded">2020-12-26T10:53:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>SLAE32 - Assignment#3 [Egghunter]</h3><div class="text-muted small"><p> This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification: http://securitytube-training.com/online-courses/securitytube-linux-assembly...</p></div></div></a></div><div class="card"> <a href="/posts/slae32-assignment-2/"><div class="card-body"> <span class="timeago small" > Dec 13 <i class="unloaded">2020-12-13T10:53:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>SLAE32 - Assignment#2 [Reverse TCP Shell]</h3><div class="text-muted small"><p> This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification: http://securitytube-training.com/online-courses/securitytube-linux-assembly...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled"><p>-</p></span> <a href="/posts/htb-blunder-writeup/" class="btn btn-outline-primary"><p>HTB - Blunder Write-up</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//bigb0ss-blog.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://bigb0sss.github.io/posts/redteam-cobalt-strike-malleable-profile/'; this.page.identifier = '/posts/redteam-cobalt-strike-malleable-profile/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2020 <a href="https://www.linkedin.com/in/danielsmin">bigb0ss</a>. <span data-toggle="tooltip" data-placement="top" title="CC BY 4.0 ">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/x86/">x86</a> <a class="post-tag" href="/tags/slae32/">slae32</a> <a class="post-tag" href="/tags/assembly/">assembly</a> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/cloud/">cloud</a> <a class="post-tag" href="/tags/zip2john/">zip2john</a> <a class="post-tag" href="/tags/web.config-rce/">web.config rce</a> <a class="post-tag" href="/tags/vhost/">vhost</a> <a class="post-tag" href="/tags/valentine/">valentine</a> <a class="post-tag" href="/tags/tomcat/">tomcat</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://bigb0sss.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">[-] No result found</p>' }); </script>
